<mxfile host="app.diagrams.net" modified="2021-12-04T02:41:11.865Z" agent="5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.55 Safari/537.36" etag="u8XX2f6lUUUBU1sqdEA7" version="15.8.7" type="github" pages="3">
  <diagram id="C5RBs43oDa-KdzZeNtuy" name="Batch ALL">
    <mxGraphModel dx="1892" dy="1064" grid="0" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1169" pageHeight="1654" math="0" shadow="0">
      <root>
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-0" />
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-1" parent="WIyWlLk6GJQsqaUBKTNV-0" />
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-2" value="" style="rounded=0;html=1;jettySize=auto;orthogonalLoop=1;fontSize=11;endArrow=block;endFill=0;endSize=8;strokeWidth=1;shadow=0;labelBackgroundColor=none;edgeStyle=orthogonalEdgeStyle;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="WIyWlLk6GJQsqaUBKTNV-3" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="206" y="223" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-3" value="Batch ALL" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="146" y="133" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="WFbMBUP2ziU1kK5NttpU-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="WFbMBUP2ziU1kK5NttpU-0" target="WFbMBUP2ziU1kK5NttpU-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="WFbMBUP2ziU1kK5NttpU-0" target="uAmXVkTUW6dZBD79vU70-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="WFbMBUP2ziU1kK5NttpU-0" value="Lấy danh sách &lt;br&gt;&lt;b&gt;1. @works - &lt;/b&gt;select các attribute từ &lt;b&gt;@all_works&lt;/b&gt;, phục vụ cho việc thống kê&lt;br&gt;2. &lt;b&gt;@all_works - &lt;/b&gt;riêng cho việc joining và truy vấn trong database, phụ vụ cho việc bulk delete &lt;b&gt;progress_aggregated_work&lt;/b&gt; tương ứng sau này&amp;nbsp;" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="61" y="193" width="290" height="110" as="geometry" />
        </mxCell>
        <mxCell id="WFbMBUP2ziU1kK5NttpU-1" value="SELECT *&lt;br&gt;FROM works&lt;br&gt;INNER JOIN work_groups ON work_groups.id = works.work_group_id&lt;br&gt;INNER JOIN main_work_types ON main_work_types.id = works.&amp;nbsp;main_work_type_id&lt;br&gt;LEFT OUTER JOINS sub_work_types ON sub_work_types.id = works.sub_work_type_id&lt;br&gt;WHERE works.updated_at &amp;lt;=&amp;nbsp;@aggregated_time&lt;br&gt;AND work_groups.work_date BETWEEN (:start_date, :end_date)&lt;br&gt;AND work_groups.field_id = @progress_aggregate_history.field_id&lt;br&gt;AND&amp;nbsp;sub_work_types.other_flag !=1 OR sub_work_types.id IS NULL&lt;br&gt;AND works.main_work_type_id IS NOT NULL&lt;br&gt;AND works.state_handling_flag != 1&lt;br&gt;AND main_work_types.other_flag != 1&lt;br&gt;AND work_groups.deleted_at = &quot;1970/01/01&quot;&lt;br&gt;AND works.deleted_at = &quot;1970/01/01&quot;&lt;br&gt;AND main_work_types.deleted_at = &quot;1970/01/01&quot;" style="rounded=0;whiteSpace=wrap;html=1;align=left;fillColor=#d5e8d4;strokeColor=#82b366;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="480.5" y="23" width="500" height="220" as="geometry" />
        </mxCell>
        <mxCell id="WFbMBUP2ziU1kK5NttpU-6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="WFbMBUP2ziU1kK5NttpU-4" target="WFbMBUP2ziU1kK5NttpU-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="WFbMBUP2ziU1kK5NttpU-4" target="UBo7ACk7U0r55q0Idaj--0">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="WFbMBUP2ziU1kK5NttpU-4" value="Lấy danh sách &lt;b&gt;@progress_work_type_setting_group&lt;/b&gt; tương ứng của field, phục vụ cho việc group, tính toán" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="62.51" y="503" width="287" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-9" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="WFbMBUP2ziU1kK5NttpU-5" target="uAmXVkTUW6dZBD79vU70-8">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="WFbMBUP2ziU1kK5NttpU-5" value="SELECT *&lt;br&gt;FROM progress_work_type_settings&lt;br&gt;LEFT OUTER JOIN field_main_work_types ON field_main_work_types.id = progress_work_type_settings.field_main_work_type_id&lt;br&gt;LEFT OUTER JOIN field_sub_work_types ON field_sub_work_types.id = progress_work_type_settings.sub_work_type_id&lt;br&gt;WHERE field_main_work_types.field_id = @progress_aggregate_history.field_id&lt;br&gt;AND progress_work_type_settings.deleted_at = &quot;1970/01/01&quot;&lt;br&gt;AND field_main_work_types.deleted_at = &quot;1970/01/01&quot;&lt;br&gt;AND field_sub_work_types.deleted_at = &quot;1970/01/01&quot;" style="rounded=0;whiteSpace=wrap;html=1;align=left;fillColor=#d5e8d4;strokeColor=#82b366;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="390.5" y="323" width="710" height="130" as="geometry" />
        </mxCell>
        <mxCell id="WFbMBUP2ziU1kK5NttpU-14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" target="uAmXVkTUW6dZBD79vU70-10" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="206" y="633" as="sourcePoint" />
            <mxPoint x="206" y="683" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="WFbMBUP2ziU1kK5NttpU-26" value="Mỗi step đều ghi lại log, đồng thời handle error xảy ra thì sẽ &lt;br&gt;1. rollback toàn toàn bộ quá trình&lt;br&gt;2. update @progress_aggrergate_history.status = error&lt;br&gt;3. Gửi mail lỗi/thành công tương ứng." style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;fillColor=#fff2cc;strokeColor=#d6b656;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="61" y="53" width="345" height="70" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-17" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="UBo7ACk7U0r55q0Idaj--0" target="uAmXVkTUW6dZBD79vU70-16">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UBo7ACk7U0r55q0Idaj--0" value="Xử lý filter @works, bằng logic =&amp;gt; &lt;b&gt;@work_filters&lt;/b&gt;" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="61.25" y="593" width="289.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-1" value="&lt;b&gt;@works&lt;/b&gt; có tồn tại hay không" style="rhombus;whiteSpace=wrap;html=1;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="139.75" y="343" width="132.49" height="90" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-7" value="" style="group" vertex="1" connectable="0" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="190.5" y="443" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="uAmXVkTUW6dZBD79vU70-7" source="uAmXVkTUW6dZBD79vU70-1" target="WFbMBUP2ziU1kK5NttpU-4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-5" value="YES" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="uAmXVkTUW6dZBD79vU70-7">
          <mxGeometry width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-8" value="&amp;nbsp;Xử lý group data lấy được từ câu query bằng câu lệnh group_by =&amp;gt;&amp;nbsp;&lt;b&gt;@progress_work_type_setting_group&lt;/b&gt;&lt;br&gt;{ [main_work_type_id, sub_work_type_id] =&amp;gt; item_list_id, ... }" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="561.25" y="483" width="368.5" height="80" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-10" value="&lt;b style=&quot;text-align: left&quot;&gt;@work_filters&lt;/b&gt;&amp;nbsp;có tồn tại hay không" style="rhombus;whiteSpace=wrap;html=1;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="125.62" y="683" width="160.75" height="100" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-19" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="uAmXVkTUW6dZBD79vU70-12" target="uAmXVkTUW6dZBD79vU70-18">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-26" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="uAmXVkTUW6dZBD79vU70-12" target="uAmXVkTUW6dZBD79vU70-24">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-12" value="Xử lý group, tính toán &lt;b&gt;@work_filter&lt;/b&gt; bằng logic&lt;br&gt;=&amp;gt; &lt;b&gt;@work_filter_calculates&lt;/b&gt;" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="61" y="833" width="289.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-15" value="" style="group" vertex="1" connectable="0" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="190.5" y="793" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-13" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="uAmXVkTUW6dZBD79vU70-15" source="uAmXVkTUW6dZBD79vU70-10" target="uAmXVkTUW6dZBD79vU70-12">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-14" value="YES" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="uAmXVkTUW6dZBD79vU70-15">
          <mxGeometry width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-16" value="Xử lý filter logic ở đây" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="480.5" y="593" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-18" value="Xử lý group, tính toán logic ở đây" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="390.5" y="703" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-34" value="" style="group;container=1;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;" vertex="1" connectable="0" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="92.26" y="929" width="227.5" height="210" as="geometry">
            <mxRectangle x="71.5" y="1080" width="50" height="44" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-20" value="1. Tạo mảng &lt;b&gt;@progress_aggregated_results&lt;/b&gt;&lt;br&gt;2. Loop &lt;b&gt;@&lt;/b&gt;&lt;b&gt;work_filter_calculates, &lt;/b&gt;assign dữ liệu&lt;b&gt; &lt;/b&gt;cho&lt;b&gt;&amp;nbsp;@progress_aggregated_results&lt;/b&gt;&lt;br&gt;3. Bulk import bằng&lt;b&gt; activerecord_import&lt;/b&gt;" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;" vertex="1" parent="uAmXVkTUW6dZBD79vU70-34">
          <mxGeometry y="100" width="227.5" height="110" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-25" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fillColor=#f5f5f5;strokeColor=#666666;" edge="1" parent="uAmXVkTUW6dZBD79vU70-34" source="uAmXVkTUW6dZBD79vU70-24" target="uAmXVkTUW6dZBD79vU70-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-24" value="Xử lý đối với bảng &lt;b&gt;progress_aggregate_results&lt;/b&gt;" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;" vertex="1" parent="uAmXVkTUW6dZBD79vU70-34">
          <mxGeometry x="24.620000000000005" width="178.26" height="50" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-41" value="" style="group;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;" vertex="1" connectable="0" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="92" y="1164" width="227.5" height="319" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-22" value="Xử lý đối với bảng &lt;b&gt;progress_aggregated_works&lt;/b&gt;" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;" vertex="1" parent="uAmXVkTUW6dZBD79vU70-41">
          <mxGeometry x="24.620000000000005" width="178.26" height="50" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-28" value="1. Tạo mảng &lt;b&gt;@progress_aggregated_results&lt;/b&gt;&lt;br&gt;2. Loop &lt;b&gt;@&lt;/b&gt;&lt;b&gt;work_filter_calculates, &lt;/b&gt;assign dữ liệu&lt;b&gt; &lt;/b&gt;cho&lt;b&gt;&amp;nbsp;@progress_aggregated_results&lt;/b&gt;&lt;br&gt;3. Bulk import bằng&lt;b&gt; activerecord_import&lt;/b&gt;" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;" vertex="1" parent="uAmXVkTUW6dZBD79vU70-41">
          <mxGeometry y="209" width="227.5" height="110" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-33" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fillColor=#f5f5f5;strokeColor=#666666;" edge="1" parent="uAmXVkTUW6dZBD79vU70-41" source="uAmXVkTUW6dZBD79vU70-29" target="uAmXVkTUW6dZBD79vU70-28">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-29" value="Bulk delete các bản ghi &lt;b&gt;progress_aggregated_works&lt;/b&gt; tương ứng với &lt;b&gt;@all_works&lt;/b&gt; đang chạy batch" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;" vertex="1" parent="uAmXVkTUW6dZBD79vU70-41">
          <mxGeometry x="24.620000000000005" y="90" width="178.26" height="70" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-30" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fillColor=#f5f5f5;strokeColor=#666666;" edge="1" parent="uAmXVkTUW6dZBD79vU70-41" source="uAmXVkTUW6dZBD79vU70-22" target="uAmXVkTUW6dZBD79vU70-29">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-42" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="uAmXVkTUW6dZBD79vU70-20" target="uAmXVkTUW6dZBD79vU70-22">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-43" value="SQL sample" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="445.5" y="973" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-44" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="uAmXVkTUW6dZBD79vU70-20" target="uAmXVkTUW6dZBD79vU70-43">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-45" value="SQL sample" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="454.5" y="1202" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-46" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="uAmXVkTUW6dZBD79vU70-29" target="uAmXVkTUW6dZBD79vU70-45">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-47" value="SQL sample" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="460.5" y="1372" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-48" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="uAmXVkTUW6dZBD79vU70-28" target="uAmXVkTUW6dZBD79vU70-47">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-49" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.478;entryY=0.019;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="uAmXVkTUW6dZBD79vU70-28" target="uAmXVkTUW6dZBD79vU70-50">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="205.75" y="1523" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-53" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="uAmXVkTUW6dZBD79vU70-50" target="uAmXVkTUW6dZBD79vU70-52">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-55" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="uAmXVkTUW6dZBD79vU70-50" target="uAmXVkTUW6dZBD79vU70-54">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-50" value="Update &lt;b&gt;@progress_aggrergate_history&lt;/b&gt; thành status success" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="84.5" y="1530" width="253" height="54" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-52" value="END" style="ellipse;whiteSpace=wrap;html=1;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="145.75" y="1610" width="120" height="28" as="geometry" />
        </mxCell>
        <mxCell id="uAmXVkTUW6dZBD79vU70-54" value="SQL sample" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="466.5" y="1527" width="120" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="1vLqcknvX-34HEY4nWMS" name="ONLY DIFF">
    <mxGraphModel dx="2895" dy="1415" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="2339" pageHeight="3300" math="0" shadow="0">
      <root>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-0" />
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-1" parent="Y1YA_CgOly7EXAXlO_jH-0" />
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-2" value="&lt;b style=&quot;text-align: center&quot;&gt;Duyệt mảng&amp;nbsp;&lt;/b&gt;&lt;span style=&quot;text-align: center&quot;&gt;changed_works&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;fillColor=#fff2cc;dashed=1;verticalAlign=top;fontStyle=1;strokeColor=#d6b656;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="670" y="1240" width="1600" height="830" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-4" target="Y1YA_CgOly7EXAXlO_jH-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-4" value="START" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="870" y="520" width="120" height="50" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-5" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-6" target="Y1YA_CgOly7EXAXlO_jH-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-6" value="&lt;b&gt;Lấy changed_works[] từ bảng works theo điều kiện:&lt;br&gt;&lt;/b&gt;updated_at/deleted_at/created_at nằm trong khoảng&lt;br&gt;[last_success_at, current_aggregated_at]&lt;br&gt;--------&lt;br&gt;Left join&amp;nbsp;progress_work_type_settings để lấy cột&amp;nbsp;item_list_id và id&lt;br&gt;(on main_work_type_id, &lt;u&gt;sub_work_type_id&lt;/u&gt;)" style="rounded=0;whiteSpace=wrap;html=1;align=center;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="750" y="940" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-9" target="Y1YA_CgOly7EXAXlO_jH-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-8" style="rounded=0;orthogonalLoop=1;jettySize=auto;html=1;endArrow=none;endFill=0;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-9" target="Y1YA_CgOly7EXAXlO_jH-39" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-9" value="&lt;b&gt;Lấy thông tin chạy batch thành công gần nhất từ bảng&amp;nbsp;progress_aggregate_histories (của field_id)&lt;br&gt;&lt;/b&gt;status = 1&lt;br&gt;field_id&lt;br&gt;------&lt;br&gt;&lt;b&gt;Sắp xếp giảm dần theo id, lấy giá trị đầu tiên (limit 1)&lt;/b&gt;&lt;br&gt;last_success_id =&amp;nbsp;id&lt;br&gt;last_success_at =&amp;nbsp;&amp;nbsp;aggregated_at" style="rounded=0;whiteSpace=wrap;html=1;align=center;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="810" y="650" width="360" height="140" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-10" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-11" target="Y1YA_CgOly7EXAXlO_jH-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-11" value="&lt;b&gt;Tạo mới thông tin chạy batch lần này&amp;nbsp;&lt;/b&gt;&lt;b&gt;(của field_id)&lt;/b&gt;&lt;b&gt;&lt;br&gt;&amp;nbsp;bảng&amp;nbsp;progress_aggregate_histories&lt;br&gt;&lt;/b&gt;status = 0&lt;br&gt;field_id&lt;br&gt;aggregated_at = aggregated_time&amp;nbsp;&lt;br&gt;------&lt;br&gt;&lt;b&gt;Kết quả&lt;/b&gt;&lt;br&gt;current_id =&amp;nbsp;id" style="rounded=0;whiteSpace=wrap;html=1;align=center;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="750" y="310" width="360" height="140" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-12" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-13" target="Y1YA_CgOly7EXAXlO_jH-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-13" value="&lt;b&gt;Duyệt mảng: i = 0-&amp;gt;length&lt;br&gt;&lt;/b&gt;changed_work =&amp;nbsp;changed_works[i]&lt;br&gt;------&lt;br&gt;&lt;b&gt;Tính toán trong vòng lặp:&lt;/b&gt;&lt;br&gt;&lt;br&gt;is_in_setting = changed_work.setting_id != null &amp;amp;&amp;amp; (item_list_id&amp;nbsp; == null ||&amp;nbsp;changed_work.a/b/c/d(tương ứng item_list_id) != null)&lt;br&gt;&lt;br&gt;progress_aggregated_work&amp;nbsp;=&amp;nbsp;progress_aggregated_works&lt;br&gt;.filter(work_id == changed_work.id)&lt;b&gt;&lt;br&gt;&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=center;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="710" y="1280" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-14" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-16" target="Y1YA_CgOly7EXAXlO_jH-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-15" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-16" target="Y1YA_CgOly7EXAXlO_jH-36" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-16" value="&lt;b&gt;Lấy progress_aggregated_works điều kiện:&lt;/b&gt;&lt;br&gt;work_id in changed_works[id]" style="rounded=0;whiteSpace=wrap;html=1;align=center;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="750" y="1100" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-17" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-20" target="Y1YA_CgOly7EXAXlO_jH-29" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1180" y="1560" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-18" value="TRUE" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="Y1YA_CgOly7EXAXlO_jH-17" vertex="1" connectable="0">
          <mxGeometry x="-0.3143" y="-2" relative="1" as="geometry">
            <mxPoint x="6" y="-2" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-19" value="FALSE" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-20" target="Y1YA_CgOly7EXAXlO_jH-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-20" value="&lt;span style=&quot;font-style: normal&quot;&gt;! is_in_setting&amp;nbsp;or&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: normal&quot;&gt;changed_work.deleted or&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;font-style: normal&quot;&gt;changed_work.blocked&lt;/span&gt;&lt;span style=&quot;font-style: normal&quot;&gt;&lt;br&gt;&lt;/span&gt;" style="rhombus;whiteSpace=wrap;html=1;shadow=0;fontFamily=Helvetica;fontSize=12;align=center;strokeWidth=1;spacing=6;spacingTop=-4;fontStyle=2" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="810" y="1510" width="240" height="100" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-21" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-22" target="Y1YA_CgOly7EXAXlO_jH-32" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-22" value="&lt;b&gt;Tìm&amp;nbsp;&lt;/b&gt;&lt;b&gt;old_&lt;/b&gt;&lt;b&gt;progress_aggregate_result theo:&lt;/b&gt;&lt;br&gt;work_date,&amp;nbsp;main_work_type_id,&amp;nbsp;&lt;u&gt;sub_work_type_id,&amp;nbsp;place_item_id&lt;/u&gt;&lt;br&gt;(của progress_aggregated_work)&lt;br&gt;--------&lt;br&gt;Nếu old_progress_aggregate_result != null: Trừ man_hours" style="rounded=0;whiteSpace=wrap;html=1;align=center;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="1470" y="1500" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-23" value="TRUE" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-25" target="Y1YA_CgOly7EXAXlO_jH-27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-24" value="FALSE" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.564;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-25" target="Y1YA_CgOly7EXAXlO_jH-34" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-25" value="&lt;span style=&quot;font-style: normal&quot;&gt;progress_aggregated_work&amp;nbsp; != null ?&lt;/span&gt;&lt;span style=&quot;font-style: normal&quot;&gt;&lt;br&gt;&lt;/span&gt;" style="rhombus;whiteSpace=wrap;html=1;shadow=0;fontFamily=Helvetica;fontSize=12;align=center;strokeWidth=1;spacing=6;spacingTop=-4;fontStyle=2" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="1150" y="1730" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-26" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-27" target="Y1YA_CgOly7EXAXlO_jH-33" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1290" y="1690" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-27" value="&lt;b&gt;Tìm old_progress_aggregate_result theo:&lt;/b&gt;&lt;br&gt;work_date,&amp;nbsp;main_work_type_id,&lt;u&gt;&amp;nbsp;sub_work_type_id,&amp;nbsp;place_item_id&lt;br&gt;&lt;/u&gt;(của progress_aggregated_work)&lt;br&gt;--------&lt;br&gt;Nếu old_progress_aggregate_result&amp;nbsp;!= null: Trừ man_hours&lt;br&gt;--------" style="rounded=0;whiteSpace=wrap;html=1;align=center;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="1470" y="1700" width="360" height="140" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-28" value="TRUE" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-29" target="Y1YA_CgOly7EXAXlO_jH-22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-29" value="&lt;span style=&quot;font-style: normal&quot;&gt;progress_aggregated_work&amp;nbsp; != null ?&lt;/span&gt;&lt;span style=&quot;font-style: normal&quot;&gt;&lt;br&gt;&lt;/span&gt;" style="rhombus;whiteSpace=wrap;html=1;shadow=0;fontFamily=Helvetica;fontSize=12;align=center;strokeWidth=1;spacing=6;spacingTop=-4;fontStyle=2" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="1150" y="1520" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-30" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-31" target="Y1YA_CgOly7EXAXlO_jH-25" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-31" value="&lt;b&gt;Tìm new_progress_aggregate_result theo:&lt;/b&gt;&lt;br&gt;work_date,&amp;nbsp;main_work_type_id,&amp;nbsp;&lt;u&gt;sub_work_type_id,&amp;nbsp;place_item_id&lt;/u&gt;&lt;br&gt;(của changed_work)&lt;br&gt;--------&lt;br&gt;Nếu&amp;nbsp;new_progress_aggregate_result&amp;nbsp;!= null: Cộng man_hours&lt;br&gt;Nếu&amp;nbsp;new_progress_aggregate_result == null: Tạo cùng man_hours" style="rounded=0;whiteSpace=wrap;html=1;align=center;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="750" y="1700" width="360" height="140" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-32" value="&lt;b&gt;Xoá progress_aggregated_work&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=center;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="1870" y="1500" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-33" value="&lt;b&gt;Update&amp;nbsp;progress_aggregated_works với&lt;/b&gt;&lt;br&gt;work_date, main_work_type_id, sub_work_type_id, place_item_id)&lt;br&gt;(của changed_work)" style="rounded=0;whiteSpace=wrap;html=1;align=center;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="1870" y="1700" width="360" height="140" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-34" value="&lt;b&gt;Tạo mới progress_aggregated_works với&lt;/b&gt;&lt;br&gt;work_date, main_work_type_id, sub_work_type_id, place_item_id)&lt;br&gt;(của changed_work)" style="rounded=0;whiteSpace=wrap;html=1;align=center;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="1470" y="1900" width="360" height="140" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-35" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-36" target="Y1YA_CgOly7EXAXlO_jH-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-36" value="&lt;b&gt;Lấy&amp;nbsp;&lt;/b&gt;&lt;b&gt;progress_aggregate_results:&lt;br&gt;&lt;br&gt;Theo changed_works: &lt;/b&gt;&lt;br&gt;work_date,&amp;nbsp;main_work_type_id, sub_work_type_id,&amp;nbsp;&lt;u&gt;place_item_id&lt;br&gt;&lt;/u&gt;works.id in changed_works[id]&lt;u&gt;&lt;br&gt;&lt;/u&gt;&lt;br&gt;&lt;b&gt;Hoặc theo&amp;nbsp;progress_aggregated_works :&lt;/b&gt;&lt;br&gt;work_date,&amp;nbsp;main_work_type_id, sub_work_type_id,&amp;nbsp;&lt;u&gt;place_item_id&lt;br&gt;&lt;/u&gt;progress_aggregated_works.id in&amp;nbsp;progress_aggregated_works[id]&lt;u&gt;&lt;br&gt;&lt;/u&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=center;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="1190" y="1060" width="360" height="160" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-37" style="rounded=0;orthogonalLoop=1;jettySize=auto;html=1;endArrow=none;endFill=0;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-38" target="Y1YA_CgOly7EXAXlO_jH-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-38" value="insert into progress_aggregate_histories (field_id, aggregated_at, status)&lt;br&gt;values (:field_id, :aggregated_time, 0)" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#d5e8d4;strokeColor=#82b366;size=17;align=left;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="1190" y="400" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-39" value="select * from&amp;nbsp;progress_aggregate_histories&lt;br&gt;where status = 1 and field = :field_id&lt;br&gt;order aggregated_at by desc&lt;br&gt;limit 1" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#d5e8d4;strokeColor=#82b366;size=17;align=left;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="1240" y="630" width="400" height="80" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-40" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-41" target="Y1YA_CgOly7EXAXlO_jH-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-41" value="&lt;br&gt;aggregated_time = now()" style="rounded=0;whiteSpace=wrap;html=1;align=center;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="750" y="120" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-42" style="edgeStyle=none;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;endArrow=none;endFill=0;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-43" target="Y1YA_CgOly7EXAXlO_jH-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-43" value="select works.*, work_settings.id as setting_id, work_settings.item_list_id from&amp;nbsp;works&lt;br&gt;&lt;br&gt;join work_groups on works.work_group_id = work_groups.id and work_groups.field_id = :field_id&lt;br&gt;&lt;br&gt;left join (&lt;br&gt;&lt;span style=&quot;white-space: pre&quot;&gt; &lt;/span&gt;select settings.*, mains.field_id, mains.main_work_type_id, subs.sub_work_type_id from progress_work_type_settings as settings&lt;br&gt;&lt;span style=&quot;white-space: pre&quot;&gt; &lt;/span&gt;left join field_main_work_types as mains on mains.id = settings.field_main_work_type_id&amp;nbsp;&lt;br&gt;&lt;span style=&quot;white-space: pre&quot;&gt; &lt;/span&gt;left join field_sub_work_types as subs on subs.id = settings.field_sub_work_type_id&lt;br&gt;) as work_settings on works.main_work_type_id = work_settings.main_work_type_id &lt;br&gt;and (work_settings.sub_work_type_id&amp;nbsp;= null or work_settings.sub_work_type_id = works.sub_work_type_id)&lt;br&gt;&lt;br&gt;where (updated_at between :last_success_at and :aggregated_time&amp;nbsp;)&lt;br&gt;or (deleted_at between :last_success_at and :aggregated_time&amp;nbsp;)&lt;br&gt;or (created_at between :last_success_at and :aggregated_time&amp;nbsp;)" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#d5e8d4;strokeColor=#82b366;size=17;align=left;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="30" y="460" width="760" height="240" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-44" style="edgeStyle=none;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;endArrow=none;endFill=0;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-45" target="Y1YA_CgOly7EXAXlO_jH-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-45" value="select * from&amp;nbsp;progress_aggregated_works&lt;br&gt;where id in (:&lt;span style=&quot;text-align: center&quot;&gt;&lt;b&gt;changed_works&lt;/b&gt;&lt;/span&gt;)&lt;br&gt;&lt;br&gt;--------&lt;br&gt;SQL sẽ hiểu đây là câu &lt;b&gt;sub_querry&lt;/b&gt;, nên không vấn đề gì nha" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#d5e8d4;strokeColor=#82b366;size=17;align=left;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="390" y="1040" width="280" height="100" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-46" style="edgeStyle=none;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;endArrow=none;endFill=0;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-47" target="Y1YA_CgOly7EXAXlO_jH-36" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-47" value="&lt;b&gt;Danh sách update_results:&lt;/b&gt;&lt;br&gt;select distinct&amp;nbsp;&lt;span style=&quot;text-align: center&quot;&gt;results.&lt;/span&gt;* from&amp;nbsp;&lt;span style=&quot;text-align: center&quot;&gt;progress_aggregate_results as results&lt;br&gt;join works &lt;br&gt;&lt;span&gt;	&lt;/span&gt;&lt;span&gt;	&lt;/span&gt;join work_groups where work_groups.id = work.id&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;on&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;results.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;work_date =&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;work_groups&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;work_date&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; and&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;results.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;main_work_type_id =&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;works.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;main_work_type_id&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; and&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;results.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;sub_work_type_id =&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;works.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;sub_work_type_id&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;where works.id in :&lt;b&gt;changed_work(sub-query)&lt;/b&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; and (&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;results.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;place_item_id&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp;= null &lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;or&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;results.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;place_item_id&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp;=&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;works.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;a_item_id&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;or&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;results.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;place_item_id&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp;=&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;works.b&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;_item_id&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;or&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;results.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;place_item_id&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp;=&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;works.c&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;_item_id&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&lt;br&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;or&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;results.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;place_item_id&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp;=&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;works.d&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;_item_id)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;b&gt;Danh sách old_results:&lt;/b&gt;&lt;br&gt;select distinct&amp;nbsp;&lt;span style=&quot;text-align: center&quot;&gt;results.&lt;/span&gt;* from&amp;nbsp;&lt;span style=&quot;text-align: center&quot;&gt;progress_aggregate_results as results&lt;br&gt;join&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;progress_aggregated_works as works&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&lt;span&gt;	&lt;/span&gt;&lt;span style=&quot;white-space: pre&quot;&gt;	&lt;/span&gt;join work_groups where work_groups.id = work.id&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;on&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;results.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;work_date =&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;work_groups&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;work_date&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; and&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;results.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;main_work_type_id =&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;works.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;main_work_type_id&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; and&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;results.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;sub_work_type_id =&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;works.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;sub_work_type_id&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;where works.work_id in :&lt;/span&gt;&lt;b style=&quot;text-align: center&quot;&gt;&amp;nbsp;changed_work(sub-query)&lt;/b&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp;and&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;and&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;results.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;place_item_id&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp;= null&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;or&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;results.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;place_item_id&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&amp;nbsp;=&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;works.&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;place_item_id&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;text-align: center&quot;&gt;&lt;br&gt;&lt;b&gt;Danh sách results ảnh hưởng:&lt;br&gt;&lt;/b&gt;results = update_results + old_results (phần chung thì tính là 1 lần)&lt;br&gt;&lt;/span&gt;" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#d5e8d4;strokeColor=#82b366;size=17;align=left;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="1670" y="800" width="560" height="380" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-48" style="edgeStyle=none;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;endArrow=none;endFill=0;" parent="Y1YA_CgOly7EXAXlO_jH-1" source="Y1YA_CgOly7EXAXlO_jH-49" target="Y1YA_CgOly7EXAXlO_jH-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Y1YA_CgOly7EXAXlO_jH-49" value="results.filter(result -&amp;gt; {&lt;br&gt;&lt;span&gt; &lt;/span&gt;&lt;span style=&quot;white-space: pre&quot;&gt; &lt;/span&gt;result.work_date ==&amp;nbsp; changed_work.work_date &amp;amp;&amp;amp;&lt;br&gt;&lt;span&gt; &lt;/span&gt;&lt;span style=&quot;white-space: pre&quot;&gt; &lt;/span&gt;result.main_work_type_id == changed_work.main_work_type_id &amp;amp;&amp;amp;&lt;br&gt;&lt;span style=&quot;white-space: pre&quot;&gt; &lt;/span&gt;(result.&lt;span style=&quot;text-align: center&quot;&gt;sub_work_type_id == null ||&amp;nbsp;&lt;/span&gt;result.&lt;span style=&quot;text-align: center&quot;&gt;sub_work_type_id ==&lt;/span&gt;&amp;nbsp;changed_work.&lt;span style=&quot;text-align: center&quot;&gt;sub_work_type_id)&lt;/span&gt;&amp;nbsp;&amp;amp;&amp;amp;&lt;br&gt;&lt;span style=&quot;white-space: pre&quot;&gt; &lt;/span&gt;(result.place_item_id == null || result.place_item_id == changed_work.a_item_id || result.place_item_id == &lt;span style=&quot;white-space: pre&quot;&gt; &lt;/span&gt;changed_work.b_item_id || result.place_item_id == changed_work.c_item_id || result.place_item_id == &lt;span style=&quot;white-space: pre&quot;&gt; &lt;/span&gt;changed_work.d_item_id)&lt;br&gt;})&lt;br&gt;Tương tự cho các block khác" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#d5e8d4;strokeColor=#82b366;size=17;align=left;" parent="Y1YA_CgOly7EXAXlO_jH-1" vertex="1">
          <mxGeometry x="30" y="1680" width="600" height="160" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="2IJdWpSvLsYcz3dNfhUG" name="BATCH DIFF ALL">
    <mxGraphModel dx="1398" dy="719" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1654" pageHeight="2336" math="0" shadow="0">
      <root>
        <mxCell id="r-6SCS9JS_Q6p-U2xnw3-0" />
        <mxCell id="r-6SCS9JS_Q6p-U2xnw3-1" parent="r-6SCS9JS_Q6p-U2xnw3-0" />
        <mxCell id="VUwFRzM8nIQZEjgPCMLg-7" value="" style="group" parent="r-6SCS9JS_Q6p-U2xnw3-1" vertex="1" connectable="0">
          <mxGeometry x="220" y="50" width="833" height="570" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-59" value="Lấy ra danh sách các progress_work_type_settings chưa được chạy batch (đổi địa điểm)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="VUwFRzM8nIQZEjgPCMLg-7" vertex="1">
          <mxGeometry x="11.732394366197184" width="222.91549295774647" height="84.44444444444444" as="geometry" />
        </mxCell>
        <mxCell id="s8o9FF4gS-mtJzS9CfyD-1" value="Lấy ra danh sách [main,sub] đã đồng bộ ở các lần lịch sử trước =&amp;gt; &lt;b&gt;@progress_work_type_is_batched&lt;br&gt;[main, sub]&lt;br&gt;&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="VUwFRzM8nIQZEjgPCMLg-7" vertex="1">
          <mxGeometry y="147.77777777777777" width="246.38028169014083" height="84.44444444444444" as="geometry" />
        </mxCell>
        <mxCell id="VUwFRzM8nIQZEjgPCMLg-4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="VUwFRzM8nIQZEjgPCMLg-7" source="RsV1DuCLyckvF859KtTO-59" target="s8o9FF4gS-mtJzS9CfyD-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="s8o9FF4gS-mtJzS9CfyD-2" value="&lt;div&gt;&lt;span&gt;SELECT main_work_type_id, sub_work_type_id&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;FROM progress_aggregate_results&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;INNER JOIN progress_aggregate_histories ON&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;span&gt;progress_aggregate_histories.id =&amp;nbsp;&lt;/span&gt;&lt;span&gt;progress_aggregate_results.&lt;/span&gt;&lt;span&gt;progress_aggregate_history_id&lt;br&gt;WHERE&amp;nbsp;&lt;/span&gt;progress_aggregate_histories.field_id = @field_id&lt;br&gt;&lt;span&gt;AND&amp;nbsp;&lt;/span&gt;progress_aggregate_histories.id &amp;lt;&amp;nbsp;&lt;b&gt;@progress_aggregate_history.id&lt;/b&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;fillColor=#d5e8d4;strokeColor=#82b366;" parent="VUwFRzM8nIQZEjgPCMLg-7" vertex="1">
          <mxGeometry x="305.0422535211268" y="137.22222222222223" width="481.0281690140845" height="105.55555555555556" as="geometry" />
        </mxCell>
        <mxCell id="s8o9FF4gS-mtJzS9CfyD-5" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="VUwFRzM8nIQZEjgPCMLg-7" source="s8o9FF4gS-mtJzS9CfyD-1" target="s8o9FF4gS-mtJzS9CfyD-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="s8o9FF4gS-mtJzS9CfyD-3" value="Lấy ra danh sách [main,sub] đã chưa bộ ở các lần lịch sử trước =&amp;gt; &lt;b&gt;@progress_work_type_batch_all&lt;br&gt;[[main, sub] =&amp;gt; item_list_id]&lt;br&gt;&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="VUwFRzM8nIQZEjgPCMLg-7" vertex="1">
          <mxGeometry y="321.94444444444446" width="246.38028169014083" height="84.44444444444444" as="geometry" />
        </mxCell>
        <mxCell id="s8o9FF4gS-mtJzS9CfyD-4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="VUwFRzM8nIQZEjgPCMLg-7" source="s8o9FF4gS-mtJzS9CfyD-1" target="s8o9FF4gS-mtJzS9CfyD-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="s8o9FF4gS-mtJzS9CfyD-6" value="&lt;div&gt;&lt;/div&gt;SELECT *&lt;br&gt;FROM progress_work_type_settings&lt;br&gt;LEFT OUTER JOIN field_main_work_types ON field_main_work_types.id = progress_work_type_settings.field_main_work_type_id&lt;br&gt;LEFT OUTER JOIN field_sub_work_types ON field_sub_work_types.id = progress_work_type_settings.sub_work_type_id&lt;br&gt;WHERE field_main_work_types.field_id = @progress_aggregate_history.field_id&lt;br&gt;AND progress_work_type_settings.deleted_at = &quot;1970/01/01&quot;&lt;br&gt;AND field_main_work_types.deleted_at = &quot;1970/01/01&quot;&lt;br&gt;AND field_sub_work_types.deleted_at = &quot;1970/01/01&quot;&lt;span&gt;&lt;br&gt;&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;fillColor=#d5e8d4;strokeColor=#82b366;" parent="VUwFRzM8nIQZEjgPCMLg-7" vertex="1">
          <mxGeometry x="305.0422535211268" y="285" width="527.9577464788732" height="158.33333333333334" as="geometry" />
        </mxCell>
        <mxCell id="VUwFRzM8nIQZEjgPCMLg-0" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="VUwFRzM8nIQZEjgPCMLg-7" source="s8o9FF4gS-mtJzS9CfyD-3" target="s8o9FF4gS-mtJzS9CfyD-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="VUwFRzM8nIQZEjgPCMLg-1" value="Xử lý bằng code, remove đi các phần tử [main,sub] đã tồn tại ở&lt;b&gt; @&lt;/b&gt;&lt;b&gt;progress_work_type_is_batched&lt;/b&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="VUwFRzM8nIQZEjgPCMLg-7" vertex="1">
          <mxGeometry x="445.83098591549293" y="485.55555555555554" width="246.38028169014083" height="84.44444444444444" as="geometry" />
        </mxCell>
        <mxCell id="VUwFRzM8nIQZEjgPCMLg-6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="VUwFRzM8nIQZEjgPCMLg-7" source="s8o9FF4gS-mtJzS9CfyD-6" target="VUwFRzM8nIQZEjgPCMLg-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="sSDgTFBMNbOVSoMMUStR-0" value="" style="group" parent="r-6SCS9JS_Q6p-U2xnw3-1" vertex="1" connectable="0">
          <mxGeometry x="130" y="690" width="1556.1399999999999" height="1580" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-27" value="Batch DIFF ALL" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;" parent="sSDgTFBMNbOVSoMMUStR-0" vertex="1">
          <mxGeometry y="196.2091503267974" width="127.79874213836477" height="41.30718954248366" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-30" value="Lấy danh sách &lt;b&gt;@works, &lt;/b&gt;không nằm trong thời gian thay đổi (&lt;b&gt;lastest_progress_aggregate_history&lt;/b&gt; và &lt;b&gt;@aggregated_time&lt;/b&gt;)&lt;br&gt;&lt;br&gt;1. @lastest_progress_aggregate_history&lt;br&gt;2. @progress_aggregate_history&lt;br&gt;3. @&lt;span&gt;aggregated_time&lt;br&gt;&lt;/span&gt;4. start_date = progress_field_settings.start_date&lt;br&gt;5. end_date = progress_field_settings.end_date&lt;br&gt;6.&amp;nbsp;&lt;span style=&quot;text-align: center&quot;&gt;&lt;b&gt;@&lt;/b&gt;&lt;/span&gt;&lt;b style=&quot;text-align: center&quot;&gt;progress_work_type_batch_all&lt;/b&gt;&lt;br&gt;&amp;nbsp;" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;fillColor=#fff2cc;strokeColor=#d6b656;" parent="sSDgTFBMNbOVSoMMUStR-0" vertex="1">
          <mxGeometry x="82.53668763102725" y="289.1503267973857" width="308.8469601677149" height="206.53594771241833" as="geometry" />
        </mxCell>
        <mxCell id="VUwFRzM8nIQZEjgPCMLg-8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="sSDgTFBMNbOVSoMMUStR-0" source="RsV1DuCLyckvF859KtTO-27" target="RsV1DuCLyckvF859KtTO-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-31" value="SELECT *&lt;br&gt;FROM works&lt;br&gt;INNER JOIN work_groups ON work_groups.id = works.work_group_id&lt;br&gt;INNER JOIN main_work_types ON main_work_types.id = works.&amp;nbsp;main_work_type_id&lt;br&gt;LEFT OUTER JOINS sub_work_types ON sub_work_types.id = works.sub_work_type_id&lt;br&gt;WHERE works.updated_at &amp;lt;=&amp;nbsp;&lt;b&gt;@lastest_progress_aggregate_history.&lt;/b&gt;&lt;b&gt;aggregated_time&lt;/b&gt;&lt;br&gt;AND work_groups.work_date BETWEEN (:start_date, :end_date)&lt;br&gt;AND work_groups.field_id = @progress_aggregate_history.field_id&lt;br&gt;AND&amp;nbsp;sub_work_types.other_flag !=1 OR sub_work_types.id IS NULL&lt;br&gt;AND works.main_work_type_id IS NOT NULL&lt;br&gt;AND works.state_handling_flag != 1&lt;br&gt;AND main_work_types.other_flag != 1&lt;br&gt;AND work_groups.deleted_at = &quot;1970/01/01&quot;&lt;br&gt;AND works.deleted_at = &quot;1970/01/01&quot;&lt;br&gt;AND main_work_types.deleted_at = &quot;1970/01/01&quot;&lt;br&gt;AND &lt;b&gt;(main_work_type_id, sub_work_type_id) IN ((&lt;/b&gt;&lt;span style=&quot;text-align: center&quot;&gt;&lt;b&gt;@&lt;/b&gt;&lt;/span&gt;&lt;b style=&quot;text-align: center&quot;&gt;progress_work_type_batch_all&lt;/b&gt;&lt;b&gt;))&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;fillColor=#d5e8d4;strokeColor=#82b366;" parent="sSDgTFBMNbOVSoMMUStR-0" vertex="1">
          <mxGeometry x="170.398322851153" width="617.6939203354298" height="237.51633986928107" as="geometry" />
        </mxCell>
        <mxCell id="VUwFRzM8nIQZEjgPCMLg-9" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" parent="sSDgTFBMNbOVSoMMUStR-0" source="RsV1DuCLyckvF859KtTO-30" target="RsV1DuCLyckvF859KtTO-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-34" value="Lấy thông tin progress_work_type_settings, tương ứng với field_id, group theo main, sub, nhằm xác định main, sub -&amp;gt; item_list_id&lt;br&gt;1. @progress_aggregate_history&lt;br&gt;&lt;br&gt;Sau đó thực hiện group theo main, sub để lấy item_list_id tương ứng:&amp;nbsp;&lt;b&gt;progress_work_type_setting_group&lt;/b&gt;&lt;br&gt;{ [main_work_type_id, sub_work_type_id] =&amp;gt; item_list_id }" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;" parent="sSDgTFBMNbOVSoMMUStR-0" vertex="1">
          <mxGeometry x="53.24947589098532" y="526.6666666666667" width="367.42138364779873" height="134.24836601307192" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-29" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="sSDgTFBMNbOVSoMMUStR-0" source="RsV1DuCLyckvF859KtTO-30" target="RsV1DuCLyckvF859KtTO-34" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-35" value="SELECT *&lt;br&gt;FROM progress_work_type_settings&lt;br&gt;LEFT OUTER JOIN field_main_work_types ON field_main_work_types.id = progress_work_type_settings.field_main_work_type_id&lt;br&gt;LEFT OUTER JOIN field_sub_work_types ON field_sub_work_types.id = progress_work_type_settings.sub_work_type_id&lt;br&gt;WHERE field_main_work_types.field_id = @progress_aggregate_history.field_id&lt;br&gt;AND progress_work_type_settings.deleted_at = &quot;1970/01/01&quot;&lt;br&gt;AND field_main_work_types.deleted_at = &quot;1970/01/01&quot;&lt;br&gt;AND field_sub_work_types.deleted_at = &quot;1970/01/01&quot;" style="rounded=0;whiteSpace=wrap;html=1;align=left;fillColor=#d5e8d4;strokeColor=#82b366;" parent="sSDgTFBMNbOVSoMMUStR-0" vertex="1">
          <mxGeometry x="513.8574423480084" y="526.6666666666667" width="756.1425576519915" height="134.24836601307192" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-32" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="sSDgTFBMNbOVSoMMUStR-0" source="RsV1DuCLyckvF859KtTO-34" target="RsV1DuCLyckvF859KtTO-35" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fWi1f5fFc3dsj06Epf7p-0" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="sSDgTFBMNbOVSoMMUStR-0" source="RsV1DuCLyckvF859KtTO-38" target="RsV1DuCLyckvF859KtTO-39">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-38" value="Khái báo 5 mảng works tương ứng để xử lý với a_item_id, b_item_id, c_item_id, d_item_id và item_list_id = NULL&lt;br&gt;&lt;br&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;@work_calculate_by_a_items&lt;/b&gt;&amp;nbsp;= []&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;@work_calculate_by_b_items&lt;/b&gt; = []&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;@work_calculate_by_c_items&lt;/b&gt; = []&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&lt;b&gt; @work_calculate_by_d_itemss&lt;/b&gt; = []&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;@work_calculate_no_item_lists&lt;/b&gt; = []&lt;/div&gt;" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;" parent="sSDgTFBMNbOVSoMMUStR-0" vertex="1">
          <mxGeometry x="53.24947589098532" y="697.0588235294118" width="367.42138364779873" height="129.08496732026146" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-33" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="sSDgTFBMNbOVSoMMUStR-0" source="RsV1DuCLyckvF859KtTO-34" target="RsV1DuCLyckvF859KtTO-38" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fWi1f5fFc3dsj06Epf7p-30" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="sSDgTFBMNbOVSoMMUStR-0" source="RsV1DuCLyckvF859KtTO-39" target="fWi1f5fFc3dsj06Epf7p-29">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-39" value="Dựa vào mảng progress_work_type_setting_group, chia các cặp &lt;b&gt;main,sub&lt;/b&gt;, ra làm 5 nhóm:&lt;br&gt;1. Theo item_list_id = 1,2,3,4&lt;br&gt;2. Theo item_list_id = nil" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;" parent="sSDgTFBMNbOVSoMMUStR-0" vertex="1">
          <mxGeometry x="449.99744234800835" y="709.967320261438" width="276.8972746331237" height="103.26797385620917" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-43" value="Xử lý với 5 mảng&amp;nbsp;&lt;b&gt;@work_calculate_by_a_item_ids (b,c,d),&amp;nbsp;&lt;/b&gt;&lt;b&gt;@work_calculate_no_item_list_ids. &lt;/b&gt;Xử lý group, tính toán data, import vào mảng&lt;b&gt;&amp;nbsp;@progress_aggregate_results&lt;/b&gt;&lt;b&gt;&amp;nbsp;&lt;/b&gt;" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;" parent="sSDgTFBMNbOVSoMMUStR-0" vertex="1">
          <mxGeometry x="53.24947589098532" y="877.7777777777778" width="367.42138364779873" height="72.28758169934642" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-36" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="sSDgTFBMNbOVSoMMUStR-0" source="RsV1DuCLyckvF859KtTO-38" target="RsV1DuCLyckvF859KtTO-43" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-44" value="SELECT&amp;nbsp;&lt;br&gt;main_work_type_id,&lt;br&gt;sub_work_type_id,&lt;br&gt;work_groups.work_date AS work_date,&lt;br&gt;works.#{ITEM_ID_COLUMNS[item_list_id]} AS place_item_id,&lt;br&gt;SUM(CASE WHEN work_groups.schedule_flag = 1 THEN works.calcd_sum_man_hours ELSE 0 END) AS schedule_man_hours,&lt;br&gt;SUM(CASE WHEN work_groups.schedule_flag = 0 THEN works.calcd_sum_man_hours ELSE 0 END) AS result_man_hours&lt;br&gt;FROM&lt;b&gt;&amp;nbsp;&lt;/b&gt;&lt;b&gt;@work_calculate_by_a_items&lt;/b&gt;&lt;br&gt;AND works.#{ITEM_ID_COLUMNS[item_list_id]}&amp;nbsp;IS NOT NULL&lt;br&gt;GROUP BY&lt;br&gt;work_groups.work_date,&lt;br&gt;main_work_type_id,&lt;br&gt;sub_work_type_id,&lt;br&gt;works.#{ITEM_ID_COLUMNS[item_list_id]}&amp;nbsp;" style="rounded=0;whiteSpace=wrap;html=1;align=left;fillColor=#d5e8d4;strokeColor=#82b366;" parent="sSDgTFBMNbOVSoMMUStR-0" vertex="1">
          <mxGeometry x="513.8574423480084" y="831.3071895424838" width="756.1425576519915" height="222.0261437908497" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-40" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="sSDgTFBMNbOVSoMMUStR-0" source="RsV1DuCLyckvF859KtTO-43" target="RsV1DuCLyckvF859KtTO-44" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-45" value="SELECT&amp;nbsp;&lt;br&gt;main_work_type_id,&lt;br&gt;sub_work_type_id,&lt;br&gt;work_groups.work_date AS work_date,&lt;br&gt;NULL AS place_item_id,&lt;br&gt;SUM(CASE WHEN work_groups.schedule_flag = 1 THEN works.calcd_sum_man_hours ELSE 0 END) AS schedule_man_hours,&lt;br&gt;SUM(CASE WHEN work_groups.schedule_flag = 0 THEN works.calcd_sum_man_hours ELSE 0 END) AS result_man_hours&lt;br&gt;FROM&lt;b&gt;&amp;nbsp;&lt;/b&gt;&lt;b&gt;@work_calculate_no_item_lists&lt;/b&gt;&lt;br&gt;GROUP BY&lt;br&gt;work_groups.work_date,&lt;br&gt;main_work_type_id,&lt;br&gt;sub_work_type_id" style="rounded=0;whiteSpace=wrap;html=1;align=left;fillColor=#d5e8d4;strokeColor=#82b366;" parent="sSDgTFBMNbOVSoMMUStR-0" vertex="1">
          <mxGeometry x="513.8574423480084" y="1073.9869281045753" width="756.1425576519915" height="222.0261437908497" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-41" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="sSDgTFBMNbOVSoMMUStR-0" source="RsV1DuCLyckvF859KtTO-43" target="RsV1DuCLyckvF859KtTO-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-48" value="1. Bulk import progress_aggregatged_works, dựa vào mảng &lt;b&gt;@&lt;/b&gt;&lt;b&gt;work_calculate_no_item_lists,&lt;br&gt;&lt;/b&gt;&lt;b&gt;@work_calculate_by_a_items,&lt;br&gt;&lt;/b&gt;&lt;b&gt;@work_calculate_by_b_items,&lt;br&gt;&lt;/b&gt;&lt;b&gt;@work_calculate_by_c_items,&lt;br&gt;&lt;/b&gt;&lt;b&gt;@work_calculate_by_d_items&lt;/b&gt;" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;" parent="sSDgTFBMNbOVSoMMUStR-0" vertex="1">
          <mxGeometry x="91.77" y="1249.54" width="258.23" height="100.46" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-53" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="sSDgTFBMNbOVSoMMUStR-0" source="RsV1DuCLyckvF859KtTO-43" target="RsV1DuCLyckvF859KtTO-48" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="351.4465408805031" y="950.0653594771243" />
              <mxPoint x="351.4465408805031" y="1177.2549019607845" />
              <mxPoint x="236.42767295597483" y="1177.2549019607845" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-49" value="SELECT works.id&lt;span&gt;,&amp;nbsp;&lt;/span&gt;works.&lt;span&gt;main_work_type_id, works.&lt;/span&gt;&lt;span&gt;sub_work_type_id,&lt;/span&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;div&gt;CASE&lt;/div&gt;&lt;div&gt;WHEN progress_work_type_settings.item_list_id = 1 AND progress_work_type_settings.field_sub_work_type_id = field_sub_work_type_id.id THEN works.a_item_id&lt;/div&gt;&lt;div&gt;WHEN progress_work_type_settings.item_list_id = 2 AND progress_work_type_settings.field_sub_work_type_id = field_sub_work_type_id.id THEN works.b_item_id&lt;/div&gt;&lt;div&gt;WHEN progress_work_type_settings.item_list_id = 3 AND progress_work_type_settings.field_sub_work_type_id = field_sub_work_type_id.id THEN works.b_item_id&lt;/div&gt;&lt;div&gt;WHEN progress_work_type_settings.item_list_id = 4 AND progress_work_type_settings.field_sub_work_type_id = field_sub_work_type_id.id THEN works.b_item_id&lt;/div&gt;&lt;div&gt;ELSE NULL&amp;nbsp;&lt;span&gt;END AS place_item_id,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;work_groups.work_date AS work_date,&lt;/div&gt;&lt;div&gt;CASE WHEN work_groups.schedule_flag = 1 THEN works.calcd_sum_man_hours ELSE 0 END) AS schedule_man_hours,&lt;/div&gt;&lt;span&gt;CASE WHEN work_groups.schedule_flag = 0 THEN works.calcd_sum_man_hours ELSE 0 END) AS result_man_hours&lt;br&gt;&lt;/span&gt;FROM&lt;b&gt;&amp;nbsp;(&lt;/b&gt;&lt;b&gt;@work_calculate_by_a_items&lt;/b&gt;&amp;nbsp;OR&amp;nbsp;&lt;b&gt;@work_calculate_by_b_items &lt;/b&gt;OR&lt;b&gt;&amp;nbsp;&lt;/b&gt;&lt;b&gt;@work_calculate_by_c_items &lt;/b&gt;OR&lt;b&gt;&amp;nbsp;&lt;/b&gt;&lt;b&gt;@work_calculate_by_d_items &lt;/b&gt;OR&lt;b&gt;&amp;nbsp;@work_calculate_no_item_lists)&lt;/b&gt;&lt;br&gt;LEFT OUTER JOIN&amp;nbsp;field_main_work_types ON&amp;nbsp;field_main_work_types.main_work_type_id = works.main_work_type_id&lt;br&gt;LEFT OUTER&amp;nbsp;JOIN&amp;nbsp;field_sub_work_types ON field_sub_work_types.sub_work_type_id = works.&amp;nbsp;field_sub_work_types&lt;br&gt;LEFT OUTER&amp;nbsp;JOIN&amp;nbsp;progress_work_type_settings ON&amp;nbsp;progress_work_type_settings.fied_main_work_type_id = field_main_work_types.id" style="rounded=0;whiteSpace=wrap;html=1;align=left;fillColor=#d5e8d4;strokeColor=#82b366;" parent="sSDgTFBMNbOVSoMMUStR-0" vertex="1">
          <mxGeometry x="336.00419287211736" y="1380.00045751634" width="933.9958071278825" height="227.18954248366015" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-55" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.599;entryDx=0;entryDy=0;entryPerimeter=0;" parent="sSDgTFBMNbOVSoMMUStR-0" source="RsV1DuCLyckvF859KtTO-48" target="RsV1DuCLyckvF859KtTO-49" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-50" value="End" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;" parent="sSDgTFBMNbOVSoMMUStR-0" vertex="1">
          <mxGeometry x="173.06079664570228" y="1497.3856209150329" width="127.79874213836477" height="41.30718954248366" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-47" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="sSDgTFBMNbOVSoMMUStR-0" source="RsV1DuCLyckvF859KtTO-48" target="RsV1DuCLyckvF859KtTO-50" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-52" value="Xử lý import vào progress_aggregate_results&lt;br&gt;1. Bản ghi nào đã được tạo tương ứng cùng với @progress_aggregate_history -&amp;gt; update&lt;br&gt;2. Bản ghi nào chưa được tạo, đẩy vào mảng và bulk import&amp;nbsp;progress_aggregate_results(Bằng một câu lệnh import) dựa vào mảng &lt;b&gt;@progress_aggregate_results&lt;/b&gt;" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;align=left;size=0;fillColor=#fff2cc;strokeColor=#d6b656;" parent="sSDgTFBMNbOVSoMMUStR-0" vertex="1">
          <mxGeometry y="1001.6993464052289" width="244.94758909853246" height="144.57516339869284" as="geometry" />
        </mxCell>
        <mxCell id="RsV1DuCLyckvF859KtTO-42" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="sSDgTFBMNbOVSoMMUStR-0" source="RsV1DuCLyckvF859KtTO-43" target="RsV1DuCLyckvF859KtTO-52" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="fWi1f5fFc3dsj06Epf7p-29" value="SELECT *&lt;br&gt;FROM &lt;b&gt;@works&lt;/b&gt;&lt;br&gt;WHERE ((main_work_type = main_work_type AND sub_work_type = sub_work_type) OR ......)&lt;br&gt;AND a_item_id IS NOT NULL&lt;br&gt;&lt;br&gt;&lt;br&gt;------------------------------------------------------------------------------------------------------------------------------------&lt;br&gt;(Cặp main,sub lấy ở bên cạnh - Vì cặp &lt;b&gt;main/sub này&lt;/b&gt; dữ liệu ít hơn rất nhiều so với &lt;b&gt;work_ids&lt;/b&gt;)&lt;br&gt;Phần xử lý a_item_id IS NOT NULL tương ứng cho b,c,d và &lt;b&gt;không&lt;/b&gt; xử lý đối với mảng&amp;nbsp;&lt;b&gt;work_calculate_no_item_lists&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="sSDgTFBMNbOVSoMMUStR-0">
          <mxGeometry x="767.9974423480083" y="678.9866666666667" width="756.1425576519915" height="134.24836601307192" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
